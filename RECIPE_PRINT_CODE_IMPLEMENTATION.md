# é…æ–¹æ‰“å°ä»£ç ç³»ç»Ÿ - å®ç°æ€»ç»“

## ğŸ“‹ éœ€æ±‚å›é¡¾

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. âœ… é€‰æ‹©æ­¥éª¤ + è¾“å…¥instruction
2. âœ… æ‰“å°ä»£ç  = æ­¥éª¤ä»£ç  + instruction (å¦‚: mk + 200 = mk200)
3. âœ… è®¾å¤‡æ­¥éª¤å¯ä»¥åŒ…å«å…¶ä»–æ­¥éª¤
4. âœ… åŒ…å«çš„æ­¥éª¤ä½¿ç”¨è®¾å¤‡å‰åç¼€åŒ…è£¹ (å¦‚: [mk200]2)
5. âœ… è¢«åŒ…å«çš„æ­¥éª¤ä¸å•ç‹¬æ‰“å°
6. âœ… æœ€ç»ˆrecipeæ‰“å°ä»£ç ä¿å­˜åˆ°æ•°æ®åº“

---

## ğŸ¯ å®ç°çš„æ–‡ä»¶

### 1. ç±»å‹å®šä¹‰æ›´æ–°
**æ–‡ä»¶**: `src/services/recipe/types.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
// RecipeStep æ–°å¢å­—æ®µ
export interface RecipeStep {
  instruction?: string            // instructionè¾“å…¥ï¼ˆå¦‚ï¼š200ã€2é”®ã€åŠ çƒ­ç­‰ï¼‰
  containedSteps?: string[]       // åŒ…å«çš„å…¶ä»–æ­¥éª¤IDï¼ˆç”¨äºè®¾å¤‡æ­¥éª¤ï¼‰
  generatedPrintCode?: string     // ç”Ÿæˆçš„æ‰“å°ä»£ç ï¼ˆæ­¥éª¤code + instructionï¼‰
}

// Recipe æ–°å¢å­—æ®µ
export interface Recipe {
  recipePrintCode?: string        // è‡ªåŠ¨ç”Ÿæˆï¼šå®Œæ•´åˆ¶ä½œæ‰“å°ä»£ç ï¼ˆåŒ…å«æ‰€æœ‰æ­¥éª¤ï¼‰
}

// StepType æ–°å¢å­—æ®µ
export interface StepType {
  code: string                    // æ‰“å°ä»£ç ï¼ˆå¦‚ï¼šmkã€[]ç­‰ï¼‰
  isContainer?: boolean           // æ˜¯å¦æ˜¯å®¹å™¨æ­¥éª¤ï¼ˆè®¾å¤‡æ­¥éª¤ï¼‰
  containerPrefix?: string        // å®¹å™¨å‰ç¼€ï¼ˆå¦‚ï¼š[ï¼‰
  containerSuffix?: string        // å®¹å™¨åç¼€ï¼ˆå¦‚ï¼š]ï¼‰
}
```

### 2. æ‰“å°ä»£ç ç”Ÿæˆå™¨
**æ–‡ä»¶**: `src/utils/printCodeGenerator.ts` (**æ–°å»º**)

**ä¸»è¦å‡½æ•°**:
- `generateStepPrintCode()`: ç”Ÿæˆå•ä¸ªæ­¥éª¤çš„æ‰“å°ä»£ç 
- `generateRecipePrintCode()`: ç”Ÿæˆå®Œæ•´é…æ–¹çš„æ‰“å°ä»£ç 
- `generateStepPreviews()`: ç”Ÿæˆå®æ—¶é¢„è§ˆæ•°æ®

**æ ¸å¿ƒé€»è¾‘**:
```typescript
// å•ä¸ªæ­¥éª¤: code + instruction
mk + 200 = mk200

// è®¾å¤‡æ­¥éª¤: [åŒ…å«çš„æ­¥éª¤]instruction
Blender([]) + åŒ…å«(mk200) + 2 = [mk200]2

// å®Œæ•´é…æ–¹: åªè¿æ¥æœªè¢«åŒ…å«çš„æ­¥éª¤
æ­¥éª¤1: mk200 (è¢«åŒ…å«) âŒ
æ­¥éª¤2: [mk200]2 âœ…
æ­¥éª¤3: sg50 âœ…
â†’ Recipeä»£ç : [mk200]2sg50
```

### 3. æ­¥éª¤ç¼–è¾‘å™¨ç»„ä»¶
**æ–‡ä»¶**: `src/pages/RecipeGuide/RecipeStepEditor.tsx` (**æ–°å»º**)

**åŠŸèƒ½**:
- æ·»åŠ /åˆ é™¤/æ’åºæ­¥éª¤
- é€‰æ‹©æ­¥éª¤ç±»å‹ï¼ˆä»stepTypesåˆ—è¡¨ï¼‰
- è¾“å…¥instruction
- è®¾å¤‡æ­¥éª¤é€‰æ‹©åŒ…å«çš„æ­¥éª¤ï¼ˆCheckboxï¼‰
- å®æ—¶æ˜¾ç¤ºæ¯ä¸ªæ­¥éª¤çš„ç”Ÿæˆä»£ç 
- æ˜¾ç¤ºè¢«åŒ…å«æ­¥éª¤çš„æ ‡è®°
- é¡¶éƒ¨æ˜¾ç¤ºæœ€ç»ˆrecipeæ‰“å°ä»£ç 

**UIç‰¹æ€§**:
- æ­¥éª¤å¡ç‰‡æ˜¾ç¤ºç”Ÿæˆçš„ä»£ç Tag
- è®¾å¤‡æ­¥éª¤æ˜¾ç¤º"ğŸ”§è®¾å¤‡"æ ‡è®°
- è¢«åŒ…å«çš„æ­¥éª¤æ˜¾ç¤º"å·²è¢«åŒ…å«"æ ‡è®°å¹¶å˜æš—
- å®æ—¶é¢„è§ˆæ‰“å°ä»£ç 
- ä»£ç è¯´æ˜Alert

### 4. é…æ–¹è¡¨å•ç»„ä»¶
**æ–‡ä»¶**: `src/pages/RecipeGuide/RecipeFormWithSteps.tsx` (**æ–°å»º**)

**åŠŸèƒ½**:
- å®Œæ•´çš„é…æ–¹åˆ›å»º/ç¼–è¾‘è¡¨å•
- é›†æˆRecipeStepEditor
- åŠ è½½æ­¥éª¤ç±»å‹åˆ—è¡¨
- æäº¤åˆ°åç«¯API
- æ”¯æŒç¼–è¾‘æ¨¡å¼

---

## ğŸ”„ æ•°æ®æµ

### å‰ç«¯æµç¨‹

```
1. ç”¨æˆ·æ“ä½œ
   â†“
2. RecipeStepEditor æ”¶é›†æ•°æ®
   steps = [
     { stepTypeId, instruction, containedSteps: [] }
   ]
   â†“
3. printCodeGenerator ç”Ÿæˆä»£ç 
   â†’ æ¯ä¸ªæ­¥éª¤ç”Ÿæˆ generatedPrintCode
   â†’ æ ‡è®°è¢«åŒ…å«çš„æ­¥éª¤
   â†’ ç”Ÿæˆæœ€ç»ˆ recipePrintCode
   â†“
4. UIå®æ—¶æ˜¾ç¤º
   - æ¯ä¸ªæ­¥éª¤çš„ä»£ç 
   - è¢«åŒ…å«æ ‡è®°
   - æœ€ç»ˆrecipeä»£ç 
   â†“
5. æäº¤åˆ°åç«¯
   POST /recipes {
     printCode: "LICE",
     steps: [...],
     // recipePrintCode ç”±åç«¯ç”Ÿæˆå¹¶ä¿å­˜
   }
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå¥¶èŒ¶é…æ–¹ (å¤§æ¯å†°)

**ç”¨æˆ·æ“ä½œ**:
1. å•†å“æ‰“å°ä»£ç : `LICE`
2. æ·»åŠ æ­¥éª¤1: Milk (mk) + "200"
3. æ·»åŠ æ­¥éª¤2: Tea (tea) + "100"
4. æ·»åŠ æ­¥éª¤3: Blender ([]) + "2" + åŒ…å«[æ­¥éª¤1, æ­¥éª¤2]
5. æ·»åŠ æ­¥éª¤4: Sugar (sg) + "50"

**ç”Ÿæˆçš„ä»£ç **:
```
æ­¥éª¤1: mk200 (è¢«åŒ…å«ï¼Œç°è‰²æ˜¾ç¤º)
æ­¥éª¤2: tea100 (è¢«åŒ…å«ï¼Œç°è‰²æ˜¾ç¤º)
æ­¥éª¤3: [mk200tea100]2 âœ…
æ­¥éª¤4: sg50 âœ…

Recipeæ‰“å°ä»£ç : [mk200tea100]2sg50
```

**ä¿å­˜åˆ°æ•°æ®åº“**:
```json
{
  "printCode": "LICE",
  "recipePrintCode": "[mk200tea100]2sg50",
  "steps": [
    {
      "stepTypeId": "milk-id",
      "instruction": "200",
      "displayOrder": 1,
      "containedSteps": []
    },
    {
      "stepTypeId": "tea-id",
      "instruction": "100",
      "displayOrder": 2,
      "containedSteps": []
    },
    {
      "stepTypeId": "blender-id",
      "instruction": "2",
      "displayOrder": 3,
      "containedSteps": [0, 1]  // åŒ…å«æ­¥éª¤1å’Œ2
    },
    {
      "stepTypeId": "sugar-id",
      "instruction": "50",
      "displayOrder": 4,
      "containedSteps": []
    }
  ]
}
```

---

## ğŸ”§ é›†æˆæ­¥éª¤

### æ–¹å¼1ï¼šæ›¿æ¢ç°æœ‰çš„RecipeFormModalV2

```typescript
// åœ¨ RecipeByModifierManager.tsx ä¸­
import RecipeFormWithSteps from './RecipeFormWithSteps'

// æ›¿æ¢
<RecipeFormModalV2
  visible={modalVisible}
  ...
/>

// æ”¹ä¸º
<RecipeFormWithSteps
  visible={modalVisible}
  ...
/>
```

### æ–¹å¼2ï¼šä¿ç•™ä¸¤è€…ï¼Œè®©ç”¨æˆ·é€‰æ‹©

```typescript
const [useNewEditor, setUseNewEditor] = useState(false)

{useNewEditor ? (
  <RecipeFormWithSteps ... />
) : (
  <RecipeFormModalV2 ... />
)}
```

---

## ğŸ¨ UIæˆªå›¾è¯´æ˜

### æ­¥éª¤ç¼–è¾‘å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â„¹ï¸ Recipeæ‰“å°ä»£ç                                 â”‚
â”‚ [mk200tea100]2sg50                              â”‚
â”‚ æ­¤ä»£ç å°†ä¿å­˜åˆ°æ•°æ®åº“ï¼Œç”¨äºè®¢å•æ‰“å°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1   å·²è¢«åŒ…å«   mk200        [â†‘][â†“][Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¥éª¤ç±»å‹: Milk (mk)                              â”‚
â”‚ Instruction: 200                                 â”‚
â”‚ âœ… ä»£ç : mk + 200 = mk200                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2   å·²è¢«åŒ…å«   tea100       [â†‘][â†“][Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¥éª¤ç±»å‹: Tea (tea)                              â”‚
â”‚ Instruction: 100                                 â”‚
â”‚ âœ… ä»£ç : tea + 100 = tea100                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3   ğŸ”§è®¾å¤‡   [mk200tea100]2  [â†‘][â†“][Ã—]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¥éª¤ç±»å‹: Blender ([])                           â”‚
â”‚ Instruction: 2                                   â”‚
â”‚                                                  â”‚
â”‚ åŒ…å«çš„æ­¥éª¤:                                       â”‚
â”‚ â˜‘ æ­¥éª¤1: Milk mk200                             â”‚
â”‚ â˜‘ æ­¥éª¤2: Tea tea100                             â”‚
â”‚                                                  â”‚
â”‚ âœ… ä»£ç : [mk200tea100]2                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4   sg50                    [â†‘][â†“][Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¥éª¤ç±»å‹: Sugar (sg)                             â”‚
â”‚ Instruction: 50                                  â”‚
â”‚ âœ… ä»£ç : sg + 50 = sg50                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[+ æ·»åŠ æ­¥éª¤]
```

---

## ğŸš€ åç«¯é›†æˆéœ€æ±‚

### æ•°æ®åº“æ›´æ–°

```sql
-- recipes è¡¨
ALTER TABLE recipes ADD COLUMN recipe_print_code VARCHAR(500);

-- recipe_steps è¡¨
ALTER TABLE recipe_steps 
  ADD COLUMN instruction VARCHAR(255),
  ADD COLUMN contained_steps JSON,
  ADD COLUMN generated_print_code VARCHAR(100);

-- step_types è¡¨
ALTER TABLE step_types
  ADD COLUMN is_container BOOLEAN DEFAULT false,
  ADD COLUMN container_prefix VARCHAR(10) DEFAULT '[',
  ADD COLUMN container_suffix VARCHAR(10) DEFAULT ']';
```

### API æ›´æ–°

1. **åˆ›å»ºé…æ–¹**: åç«¯æ¥æ”¶stepsæ•°ç»„ï¼Œç”ŸæˆrecipePrintCode
2. **è¿”å›é…æ–¹**: åŒ…å«recipePrintCodeå­—æ®µ
3. **è¿”å›æ­¥éª¤**: åŒ…å«instructionå’ŒcontainedStepså­—æ®µ

### æ‰“å°ä»£ç ç”Ÿæˆï¼ˆåç«¯ï¼‰

å¯ä»¥å¤ç”¨å‰ç«¯çš„é€»è¾‘ï¼Œæˆ–ç”¨SQL/Pythoné‡æ–°å®ç°ï¼š

```python
def generate_recipe_print_code(steps, step_types):
    contained = set()
    for step in steps:
        if step.contained_steps:
            contained.update(step.contained_steps)
    
    codes = []
    for i, step in enumerate(steps):
        if i in contained:
            continue
        
        step_type = step_types[step.step_type_id]
        code = step_type.code + (step.instruction or '')
        
        if step_type.is_container and step.contained_steps:
            prefix = step_type.container_prefix or '['
            suffix = step_type.container_suffix or ']'
            contained_codes = ''.join([
                step_types[steps[j].step_type_id].code + (steps[j].instruction or '')
                for j in step.contained_steps
            ])
            code = f"{prefix}{contained_codes}{suffix}{step.instruction or ''}"
        
        codes.append(code)
    
    return ''.join(codes)
```

---

## âœ… åŠŸèƒ½æ£€æŸ¥æ¸…å•

### å·²å®ç°ï¼ˆå‰ç«¯ï¼‰
- [x] ç±»å‹å®šä¹‰æ›´æ–°
- [x] æ‰“å°ä»£ç ç”Ÿæˆå™¨
- [x] æ­¥éª¤ç¼–è¾‘å™¨ç»„ä»¶
- [x] é…æ–¹è¡¨å•ç»„ä»¶
- [x] å®æ—¶é¢„è§ˆ
- [x] åŒ…å«æ­¥éª¤é€‰æ‹©
- [x] è¢«åŒ…å«æ ‡è®°
- [x] æ­¥éª¤æ’åº
- [x] å®Œæ•´æ–‡æ¡£

### å¾…å®ç°ï¼ˆé›†æˆï¼‰
- [ ] é›†æˆåˆ°RecipeByModifierManager
- [ ] æ›¿æ¢æˆ–å…±å­˜æ—§è¡¨å•
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹
- [ ] i18nç¿»è¯‘

### å¾…å®ç°ï¼ˆåç«¯ï¼‰
- [ ] æ•°æ®åº“schemaæ›´æ–°
- [ ] APIæ¥å—æ–°å­—æ®µ
- [ ] ç”ŸæˆrecipePrintCodeé€»è¾‘
- [ ] è¿”å›æ–°å­—æ®µ
- [ ] æµ‹è¯•æ‰“å°ä»£ç ç”Ÿæˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ä½¿ç”¨æŒ‡å—](./RECIPE_PRINT_CODE_GUIDE.md)
- [APIæ–‡æ¡£](./src/pages/MenuCenter/ModifierGroupApi/api.md)

---

**å®ç°çŠ¶æ€**: å‰ç«¯å®Œæˆ âœ…  
**å¾…åç«¯**: æ•°æ®åº“ + APIæ›´æ–°  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-31














